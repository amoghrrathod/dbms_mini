drop database if exists gamestoredb;
create database gamestoredb;
use gamestoredb;

create table users (
user_id int auto_increment primary key,
user_name varchar (100) not null,
email varchar (255) not null unique,
password varchar (255) not null,
dob date,
index (user_name)
) ;

create table user_address (
address_id int auto_increment primary key,
user_id int not null,
address_lines text,
pincode varchar (20),
foreign key (user_id) references users (user_id) on delete cascade
) ;

create table friendships (
user_id1 int not null,
user_id2 int not null,
added_date datetime default current_timestamp,
primary key (user_id1, user_id2),
foreign key (user_id1) references users (user_id) on delete cascade,
foreign key (user_id2) references users (user_id) on delete cascade,
check (user_id1 < user_id2)
) ;

create table publishers (
publisher_id int auto_increment primary key,
publisher_name varchar (150) not null unique,
country varchar (100)
) ;

create table developers (
dev_id int auto_increment primary key,
studio varchar (150) not null,
country varchar (100)
) ;

create table tags (
tag_id int auto_increment primary key,
tag_name varchar (50) not null unique,
parent_tag_id int,
foreign key (parent_tag_id) references tags (tag_id) on delete set null
) ;

create table games (
game_id int auto_increment primary key,
game_name varchar (255) not null,
description text,
release_date date,
price decimal (10, 2),
age_rating varchar (10),
publisher_id int,
dev_id int,
foreign key (publisher_id) references publishers (publisher_id) on delete set null,
foreign key (dev_id) references developers (dev_id) on delete set null,
index (game_name)
) ;

create table has_tags (
game_id int not null,
tag_id int not null,
primary key (game_id, tag_id),
foreign key (game_id) references games (game_id) on delete cascade,
foreign key (tag_id) references tags (tag_id) on delete cascade
) ;

create table user_library (
user_id int not null,
game_id int not null,
purchase_date datetime,
hours_played decimal (10, 1) default 0.0,
primary key (user_id, game_id),
foreign key (user_id) references users (user_id) on delete cascade,
foreign key (game_id) references games (game_id) on delete cascade
) ;

create table reviews (
review_id int auto_increment primary key,
user_id int,
game_id int not null,
rating int not null,
check (rating > = 0 and rating < = 5),
review_text text,
post_date datetime default current_timestamp,
foreign key (user_id) references users (user_id) on delete set null,
foreign key (game_id) references games (game_id) on delete cascade,
check (rating > = 1 and rating < = 5)
) ;

create table achievements (
unlocked_achievement_id int auto_increment primary key,
user_id int not null,
game_id int not null,
achievement_name varchar (255) not null,
description text,
unlock_timestamp datetime not null,
foreign key (user_id) references users (user_id) on delete cascade,
foreign key (game_id) references games (game_id) on delete cascade
) ;

create table items (
item_id int auto_increment primary key,
game_id int not null,
item_name varchar (150) not null,
description text,
foreign key (game_id) references games (game_id) on delete cascade
) ;

create table item_instances (
instance_id int auto_increment primary key,
item_id int not null,
user_id int,
date_acquired datetime not null,
foreign key (item_id) references items (item_id) on delete cascade,
foreign key (user_id) references users (user_id) on delete set null
) ;

insert into users (user_name, email, password, dob) values
('alice', 'alice@email.com', 'password1', '1995-04-12'),
('bob', 'bob@email.com', 'password2', '1998-07-22'),
('charlie', 'charlie@email.com', 'password3', '1992-11-30'),
('diana', 'diana@email.com', 'password4', '2001-01-15') ;

insert into user_address (user_id, address_lines, pincode) values
(1, '123 Pixel Street, Tech City', '560001'),
(3, '456 Quest Road, Fantasy Ville', '560025') ;

insert into publishers (publisher_name, country) values
('PixelPush Inc.', 'USA'),
('GigaGames', 'Japan'),
('IndieDream Co.', 'Canada'),
('Quantum Leap Studios', 'USA'),
('Nebula Interactive', 'UK'),
('Dragonfly Games', 'China'),
('Vortex Creations', 'Germany'),
('Mirage Entertainment', 'France'),
('Crimson Peak', 'South Korea'),
('Evergreen Gaming', 'Sweden') ;

insert into developers (studio, country) values
('Starlight Studios', 'USA'),
('CodeWizards', 'UK'),
('Lone Wolf Dev', 'Canada'),
('Celestial Forge', 'USA'),
('PixelHeart', 'Japan'),
('Clockwork Giants', 'Germany'),
('Ghost-Ware', 'Sweden'),
('Red Moon Studios', 'Poland'),
('Blue-shift', 'USA'),
('Dream-weavers', 'France') ;

INSERT INTO tags (tag_name, parent_tag_id) VALUES
('RPG',
NULL),
('Action',
NULL),
('Sci-Fi',
NULL),
('Puzzle',
NULL),
('Open World',
NULL),
('Strategy',
NULL),
('Simulation',
NULL),
('Action RPG',
1),
('JRPG',
1),
('Tactical RPG',
1),
('MMORPG',
1),
('Platformer',
2),
('Shooter',
2),
('Fighting',
2),
('Hack and Slash',
2),
('Real-Time Strategy (RTS)',
6),
('Turn-Based Strategy (TBS)',
6),
('Grand Strategy',
6),
('Tower Defense',
6),
('Vehicle Simulation',
7),
('Life Simulation',
7),
('Construction & Management',
7),
('First-Person Shooter (FPS)',
13),
('Third-Person Shooter (TPS)',
13),
('MOBA',
17),
('4X',
18),
('Flight Sim',
21),
('Racing Sim',
21) ;

insert into games (game_name,
description,
release_date,
price,
age_rating,
publisher_id,
dev_id) values
('Cybernetic Dawn',
'A thrilling sci-fi action RPG.',
'2023-05-20',
59.99,
'18+',
1,
1),
('Kingdoms of Ether',
'A vast open-world fantasy RPG.',
'2022-11-10',
49.99,
'16+',
1,
2),
('Puzzle Sphere',
'A relaxing and challenging puzzle game.',
'2024-01-15',
19.99,
'3+',
3,
3),
('Galactic Marauder',
'A fast-paced space strategy game.',
'2023-08-01',
39.99,
'12+',
2,
1),
('Project Chimera',
'A tactical RPG set in a dystopian future.',
'2023-09-12',
45.00,
'16+',
4,
4),
('Stardust Odyssey',
'An epic JRPG adventure across the cosmos.',
'2022-07-21',
55.00,
'12+',
5,
5),
('City Builders Deluxe',
'The ultimate construction and management simulation.',
'2023-02-28',
39.99,
'3+',
6,
6),
('Phantom Signal',
'A stealth-action game with a gripping narrative.',
'2024-03-19',
49.99,
'18+',
7,
7),
('The Last Spell',
'A turn-based strategy game with rogue-lite elements.',
'2023-03-09',
24.99,
'16+',
8,
8),
('AstroShift',
'A mind-bending puzzle-platformer.',
'2022-10-05',
15.00,
'7+',
9,
9),
('World at War: 1944',
'A grand strategy game set in World War II.',
'2023-11-11',
35.00,
'12+',
10,
10),
('Neon Riders',
'A fast-paced cyberpunk racing game.',
'2024-04-25',
29.99,
'12+',
1,
4),
('Dragon''s Breath',
'An open-world fantasy MMORPG.',
'2023-01-10',
0.00,
'16+',
2,
5),
('Cosmic Drift',
'A space combat simulation with realistic physics.',
'2022-12-01',
40.00,
'7+',
3,
6),
('The Forgotten City',
'A mystery adventure game with a time loop mechanic.',
'2021-07-28',
29.99,
'16+',
4,
7),
('Shattered Realms',
'A dark fantasy action RPG.',
'2024-05-30',
59.99,
'18+',
5,
8),
('Dungeon Masters',
'A co-op hack and slash game.',
'2023-06-15',
19.99,
'16+',
6,
9),
('Starship Tycoon',
'A business simulation game in space.',
'2022-09-01',
25.00,
'3+',
7,
10),
('The Crimson Curse', 'A gothic horror RPG.', '2023-10-31', 49.99, '18+', 8, 1),
('Cyber Heist',
'A stealth game with a focus on hacking.',
'2024-02-14',
39.99,
'16+',
9,
2),
('Age of Sail: Empires',
'A naval strategy game.',
'2022-08-18',
34.99,
'12+',
10,
3),
('The Last Stand: Aftermath',
'A zombie survival rogue-lite.',
'2021-11-16',
24.99,
'18+',
1,
4),
('Project Warlock 2',
'A retro-style first-person shooter.',
'2022-06-10',
19.99,
'18+',
2,
5),
('The Wandering Village',
'A city-building simulation game on the back of a giant creature.',
'2022-09-14',
24.99,
'12+',
3,
6),
('Gloomwood',
'A stealth horror FPS that lets you play your way.',
'2022-08-16',
19.99,
'18+',
4,
7),
('Tunic',
'An isometric action-adventure game about a small fox on a big adventure.',
'2022-03-16',
29.99,
'7+',
5,
8),
('Stray',
'A third-person cat adventure game set amidst the detailed, neon-lit alleys of a decaying cybercity.',
'2022-07-19',
29.99,
'12+',
6,
9),
('V Rising', 'A vampire survival game.', '2022-05-17', 19.99, '16+', 7, 10),
('Warhammer 40,000: Boltgun',
'A retro-style first-person shooter set in the Warhammer 40,000 universe.',
'2023-05-23',
21.99,
'18+',
8,
1),
('Dredge',
'A single-player fishing adventure with a sinister undercurrent.',
'2023-03-30',
24.99,
'12+',
9,
2),
('Dave the Diver',
'A casual, single-player adventure RPG featuring deep-sea exploration and fishing during the day and sushi restaurant management at night.',
'2023-06-28',
19.99,
'7+',
10,
3),
('Lethal Company',
'A co-op horror game about scavenging abandoned moons.',
'2023-10-23',
9.99,
'18+',
1,
4),
('Enshrouded',
'A survival, crafting, and action RPG combat game.',
'2024-01-24',
29.99,
'16+',
2,
5),
('Palworld',
'A monster-taming, survival, and crafting game.',
'2024-01-19',
29.99,
'12+',
3,
6),
('Helldivers 2',
'A third-person shooter from Arrowhead Game Studios.',
'2024-02-08',
39.99,
'18+',
4,
7),
('Baldur''s Gate 3',
'A story-rich, party-based RPG set in the universe of Dungeons & Dragons.',
'2023-08-03',
59.99,
'18+',
5,
8),
('Elden Ring',
'An action RPG from FromSoftware.',
'2022-02-25',
59.99,
'18+',
6,
9),
('Cyberpunk 2077',
'An open-world, action-adventure story from CD PROJEKT RED.',
'2020-12-10',
59.99,
'18+',
7,
10),
('The Witcher 3: Wild Hunt',
'A story-driven, open-world RPG from CD PROJEKT RED.',
'2015-05-19',
39.99,
'18+',
8,
1),
('Red Dead Redemption 2',
'An epic tale of life in America at the dawn of the modern age.',
'2018-10-26',
59.99,
'18+',
9,
2),
('Grand Theft Auto V',
'An open-world action-adventure game from Rockstar Games.',
'2013-09-17',
29.99,
'18+',
10,
3),
('Minecraft',
'A game about placing blocks and going on adventures.',
'2011-11-18',
26.95,
'7+',
1,
4),
('Terraria',
'A 2D sandbox game with gameplay that revolves around exploration, building, crafting, combat, and mining.',
'2011-05-16',
9.99,
'12+',
2,
5),
('Stardew Valley',
'A farming simulation game.',
'2016-02-26',
14.99,
'7+',
3,
6),
('Hollow Knight',
'A 2D action-adventure game with an emphasis on exploration and combat.',
'2017-02-24',
14.99,
'7+',
4,
7),
('Celeste',
'A single-player platformer about climbing a mountain.',
'2018-01-25',
19.99,
'7+',
5,
8),
('Undertale',
'A role-playing game where you don''t have to destroy anyone.',
'2015-09-15',
9.99,
'12+',
6,
9),
('Factorio',
'A game in which you build and maintain factories.',
'2020-08-14',
30.00,
'12+',
7,
10),
('RimWorld',
'A sci-fi colony sim driven by an intelligent AI storyteller.',
'2018-10-17',
34.99,
'16+',
8,
1),
('Slay the Spire',
'A single-player deckbuilder that fuses card games and roguelikes together.',
'2019-01-23',
24.99,
'12+',
9,
2),
('Dead Cells',
'A rogue-lite, metroidvania-inspired, action-platformer.',
'2018-08-07',
24.99,
'16+',
10,
3),
('The Binding of Isaac: Rebirth',
'A randomly generated action RPG shooter with heavy rogue-like elements.',
'2014-11-04',
14.99,
'16+',
1,
4),
('Enter the Gungeon',
'A bullet hell dungeon crawler following a band of misfits seeking to shoot, loot, dodge roll and table-flip their way to personal absolution.',
'2016-04-05',
14.99,
'12+',
2,
5),
('Darkest Dungeon',
'A challenging gothic roguelike turn-based RPG about the psychological stresses of adventuring.',
'2016-01-19',
24.99,
'16+',
3,
6),
('FTL: Faster Than Light',
'A spaceship simulation roguelike-like.',
'2012-09-14',
9.99,
'7+',
4,
7),
('Into the Breach',
'A turn-based strategy game where you control giant mechs to defend against an alien invasion.',
'2018-02-27',
14.99,
'7+',
5,
8),
('Papers, Please',
'A dystopian document thriller.',
'2013-08-08',
9.99,
'16+',
6,
9),
('Return of the Obra Dinn',
'An insurance adventure with minimal color.',
'2018-10-18',
19.99,
'16+',
7,
10),
('Outer Wilds',
'An open world mystery about a solar system trapped in an endless time loop.',
'2019-05-28',
24.99,
'7+',
8,
1),
('Subnautica',
'An underwater adventure game set on an alien ocean planet.',
'2018-01-23',
29.99,
'12+',
9,
2),
('The Forest',
'A first-person survival horror game.',
'2018-04-30',
19.99,
'18+',
10,
3),
('Valheim',
'A brutal exploration and survival game for 1-10 players, set in a procedurally-generated purgatory inspired by viking culture.',
'2021-02-02',
19.99,
'16+',
1,
4),
('Phasmophobia',
'A 4 player online co-op psychological horror where you and your team members of paranormal investigators will enter haunted locations filled with paranormal activity and gather as much evidence of the paranormal as you can.',
'2020-09-18',
13.99,
'16+',
2,
5),
('Among Us',
'An online and local party game of teamwork and betrayal for 4-15 players.',
'2018-11-16',
4.99,
'7+',
3,
6),
('Fall Guys',
'A massively multiplayer party game with up to 60 players online in a free-for-all struggle through round after round of escalating chaos until one victor remains!',
'2020-08-04',
0.00,
'3+',
4,
7),
('Rocket League',
'A high-powered hybrid of arcade-style soccer and vehicular mayhem.',
'2015-07-07',
0.00,
'3+',
5,
8),
('Apex Legends',
'A free-to-play battle royale-hero shooter game.',
'2019-02-04',
0.00,
'16+',
6,
9),
('Fortnite',
'A free-to-play battle royale game with numerous game modes for every type of player.',
'2017-07-25',
0.00,
'12+',
7,
10),
('Overwatch 2',
'A team-based action game set in an optimistic future.',
'2022-10-04',
0.00,
'12+',
8,
1),
('Valorant',
'A 5v5 character-based tactical shooter.',
'2020-06-02',
0.00,
'16+',
9,
2),
('League of Legends',
'A team-based game with over 140 champions to make epic plays with.',
'2009-10-27',
0.00,
'12+',
10,
3),
('Dota 2',
'A multiplayer online battle arena (MOBA) video game developed and published by Valve.',
'2013-07-09',
0.00,
'16+',
1,
4),
('Counter-Strike: Global Offensive',
'A multiplayer first-person shooter.',
'2012-08-21',
0.00,
'18+',
2,
5),
('Team Fortress 2',
'A team-based first-person shooter multiplayer video game developed and published by Valve.',
'2007-10-10',
0.00,
'16+',
3,
6),
('Warframe',
'An online action game that includes elements of shooters, RPGs and stealth games.',
'2013-03-25',
0.00,
'16+',
4,
7),
('Path of Exile',
'An online action RPG set in a dark fantasy world.',
'2013-10-23',
0.00,
'16+',
5,
8),
('Destiny 2',
'An action MMO with a single evolving world that you and your friends can join anytime, anywhere, absolutely free.',
'2017-09-06',
0.00,
'16+',
6,
9),
('Genshin Impact',
'An open-world action RPG.',
'2020-09-28',
0.00,
'12+',
7,
10),
('Honkai: Star Rail',
'A new HoYoverse space fantasy RPG.',
'2023-04-26',
0.00,
'12+',
8,
1),
('Final Fantasy XIV Online',
'A massively multiplayer online role-playing game (MMORPG) with a persistent world.',
'2013-08-27',
19.99,
'16+',
9,
2),
('The Elder Scrolls Online',
'A massively multiplayer online role-playing game (MMORPG) set in the Elder Scrolls universe.',
'2014-04-04',
19.99,
'18+',
10,
3),
('World of Warcraft',
'A massively multiplayer online role-playing game (MMORPG).',
'2004-11-23',
14.99,
'12+',
1,
4),
('Guild Wars 2',
'A massively multiplayer online role-playing game with a non-subscription business model.',
'2012-08-28',
0.00,
'12+',
2,
5),
('Black Desert Online',
'A sandbox-centered massively multiplayer online role-playing game.',
'2016-03-03',
9.99,
'16+',
3,
6),
('Albion Online',
'A sandbox MMORPG set in an open medieval fantasy world.',
'2017-07-17',
0.00,
'12+',
4,
7),
('EVE Online',
'A player-driven, persistent-world massively multiplayer online role-playing game set in a science fiction space setting.',
'2003-05-06',
0.00,
'12+',
5,
8),
('Star Wars: The Old Republic',
'A massively multiplayer online role-playing game based in the Star Wars universe.',
'2011-12-20',
0.00,
'16+',
6,
9),
('Neverwinter',
'A free-to-play, action MMORPG based on the acclaimed Dungeons & Dragons fantasy roleplaying game.',
'2013-06-20',
0.00,
'16+',
7,
10),
('Star Trek Online',
'A massively multiplayer online role-playing game and the first of its kind based on the Star Trek franchise.',
'2010-02-02',
0.00,
'12+',
8,
1),
('DC Universe Online',
'A free-to-play action combat massive multiplayer online game set in the fictional universe of DC Comics.',
'2011-01-11',
0.00,
'16+',
9,
2),
('Lord of the Rings Online',
'A massively multiplayer online role-playing game set in Middle-earth during the time of The Lord of the Rings.',
'2007-04-24',
0.00,
'12+',
10,
3),
('Age of Conan: Unchained',
'A free-to-play, massively multiplayer online role-playing game set in the fantasy world of Hyboria.',
'2008-05-20',
0.00,
'18+',
1,
4),
('EverQuest II',
'A 3D fantasy massively multiplayer online role-playing game (MMORPG).',
'2004-11-08',
0.00,
'16+',
2,
5),
('Rift',
'A fantasy free-to-play massively multiplayer online role-playing game.',
'2011-03-01',
0.00,
'16+',
3,
6),
('ArcheAge',
'A medieval fantasy massively multiplayer online role-playing game.',
'2014-09-16',
0.00,
'18+',
4,
7),
('Blade & Soul',
'A Korean fantasy martial arts massively multiplayer online role-playing game.',
'2016-01-19',
0.00,
'16+',
5,
8),
('MapleStory',
'A 2D, side-scrolling massively multiplayer online role-playing game.',
'2005-05-11',
0.00,
'7+',
6,
9),
('RuneScape',
'A fantasy massively multiplayer online role-playing game.',
'2001-01-04',
0.00,
'12+',
7,
10),
('Old School RuneScape',
'A massively multiplayer online role-playing game.',
'2013-02-22',
0.00,
'12+',
8,
1),
('Tibia',
'A massively multiplayer online role-playing game.',
'1997-01-07',
0.00,
'12+',
9,
2),
('Ultima Online',
'A massively multiplayer online role-playing game.',
'1997-09-24',
0.00,
'12+',
10,
3) ;

insert into friendships (user_id1, user_id2, added_date) values
(1, 2, '2024-03-01 10:00:00'),
(1, 3, '2024-04-15 12:30:00'),
(2, 4, '2024-05-20 18:00:00') ;

insert into has_tags (game_id, tag_id) values
(1, 2), (1, 3), (1, 1),
(2, 1), (2, 5),
(3, 4),
(4, 3), (4, 6) ;

insert into user_library (user_id, game_id, purchase_date, hours_played) values
(1, 1, '2023-06-01 14:00:00', 80.5),
(1, 3, '2024-01-20 09:00:00', 25.0),
(2, 1, '2023-05-21 11:00:00', 120.0),
(2, 2, '2022-12-01 20:00:00', 250.2),
(3, 1, '2023-05-20 00:01:00', 95.5),
(3, 2, '2023-01-10 17:00:00', 150.0),
(3, 4, '2023-08-15 13:00:00', 60.0),
(4, 3, '2024-02-14 10:00:00', 15.5) ;

insert into reviews (user_id, game_id, rating, review_text, post_date) values
(1,
1,
5,
'Amazing graphics and story! A must-play sci-fi RPG.',
'2023-07-10 22:00:00'),
(2,
2,
5,
'I have lost hundreds of hours to this game. The world is massive.',
'2023-03-05 19:30:00'),
(4,
3,
4,
'Really clever puzzles, great for a chill evening.',
'2024-03-01 16:45:00') ;

insert into achievements (user_id,
game_id,
achievement_name,
description,
unlock_timestamp) values
(1,
1,
'First Hack',
'Successfully complete the hacking tutorial.',
'2023-06-01 15:30:00'),
(3,
1,
'First Hack',
'Successfully complete the hacking tutorial.',
'2023-05-20 01:00:00'),
(3, 1, 'Chrome Justice', 'Defeat the first major boss.', '2023-06-15 14:00:00'),
(2,
2,
'Slay a Dragon',
'Defeat your first dragon in the wild.',
'2023-01-20 18:00:00'),
(2,
2,
'Master Enchanter',
'Craft a legendary enchanted item.',
'2023-04-10 21:15:00') ;

insert into items (game_id, item_name, description) values
(1, 'Plasma Rifle', 'Standard issue energy weapon.'),
(1, 'Stealth Cloak', 'Allows for temporary invisibility.'),
(2, 'Elven Sword', 'A finely crafted blade from the Silver Woods.'),
(2, 'Health Potion', 'Restores a moderate amount of health.') ;

insert into item_instances (item_id, user_id, date_acquired) values
(1, 1, '2023-06-05 12:00:00'),
(3, 2, '2023-02-11 11:30:00'),
(4, 2, '2023-02-11 11:32:00'),
(2, 3, '2023-07-01 19:00:00') ;

DELIMITER $$
CREATE TRIGGER prevent_review_if_not_owned
BEFORE INSERT ON reviews
FOR EACH ROW
BEGIN
    IF (SELECT COUNT(*) FROM user_library WHERE user_id = NEW.user_id AND game_id = NEW.game_id) = 0 THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Cannot review a game you do not own.';
    END IF;
END$$
DELIMITER ;

DELIMITER $$
CREATE FUNCTION get_average_game_rating(g_id INT)
RETURNS DECIMAL(3,2)
DETERMINISTIC
BEGIN
    DECLARE avg_rating DECIMAL(3,2);
    SELECT AVG(rating) INTO avg_rating FROM reviews WHERE game_id = g_id;
    RETURN avg_rating;
END$$
DELIMITER ;

DELIMITER $$
CREATE PROCEDURE get_games_by_tag(IN tag_name_param VARCHAR(50))
BEGIN
    SELECT g.game_id, g.game_name, g.description, g.release_date, g.price
    FROM games g
    JOIN has_tags ht ON g.game_id = ht.game_id
    JOIN tags t ON ht.tag_id = t.tag_id
    WHERE t.tag_name = tag_name_param;
END$$
DELIMITER ;
